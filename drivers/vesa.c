#include <vesa.h>
#include <colors.h>
#include <util.h>
#include <font8.h>
#include <stdarg.h>

struct vbe_mode_info_structure* vbe_info;

uint8_t test_icon16[16][16] = {
    {0x00,0x00,0x92,0x92,0x92,0x92,0x92,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
    ,{0x00,0x92,0xdb,0xfc,0xdb,0xfc,0xdb,0x92,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
    ,{0x92,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0x92,0x92,0x92,0x92,0x92,0x92,0x00,0x00}
    ,{0x92,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x92,0x00,0x00}
    ,{0x92,0xff,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0x92,0x00,0x00}
    ,{0x92,0xff,0xdb,0xfc,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x00}
    ,{0x92,0xff,0xfc,0xdb,0x92,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0x00}
    ,{0x92,0xff,0xdb,0xfc,0x92,0x92,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x92,0x00}
    ,{0x92,0xff,0xfc,0xdb,0x92,0x92,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x92,0x00}
    ,{0x92,0xff,0xdb,0xfc,0x92,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xdb,0x00}
    ,{0x92,0xff,0xfc,0xdb,0x92,0xff,0xff,0xfc,0x80,0xff,0xff,0x03,0xff,0xff,0xdb,0x00}
    ,{0x92,0x92,0x92,0x92,0x92,0xff,0x80,0xe0,0x80,0xff,0x10,0x1f,0x03,0xff,0xdb,0x00}
    ,{0x00,0x00,0x00,0x00,0x92,0xff,0xff,0x80,0xff,0xff,0xff,0x10,0x10,0xff,0xdb,0x00}
    ,{0x00,0x00,0x00,0x00,0x92,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xdb,0x00}
    ,{0x00,0x00,0x00,0x00,0x92,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0x00}
    ,{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
};

uint8_t cursor[16][16] = {
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
    ,{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
    ,{0x00,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
    ,{0x00,0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
    ,{0x00,0xff,0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
    ,{0x00,0xff,0xff,0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
    ,{0x00,0xff,0xff,0xff,0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
    ,{0x00,0xff,0xff,0xff,0xff,0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
    ,{0x00,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
    ,{0x00,0xff,0xff,0xff,0xff,0xff,0x92,0x92,0x92,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
    ,{0x00,0xff,0xff,0x92,0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
    ,{0x00,0xff,0x92,0x00,0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
    ,{0x00,0x92,0x00,0x00,0x00,0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
    ,{0x00,0x00,0x00,0x00,0x00,0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
    ,{0x00,0x00,0x00,0x00,0x00,0x00,0xff,0x92,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
    ,{0x00,0x00,0x00,0x00,0x00,0x00,0x92,0x92,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
};

uint8_t test_icon32[32][32] = {
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
,{0x00,0x00,0x00,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
,{0x00,0x00,0x92,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x92,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
,{0x00,0x92,0xff,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0x92,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
,{0x92,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x00,0x00,0x00,0x00,0x00,0x00}
,{0x92,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x00}
,{0x92,0xff,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0x90,0x00,0x00,0x00,0x00,0x00}
,{0x92,0xff,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0x90,0x00,0x00,0x00,0x00,0x00}
,{0x92,0xff,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0x90,0x00,0x00,0x00,0x00,0x00}
,{0x92,0xff,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0x90,0x00,0x00,0x00,0x00,0x00}
,{0x92,0xff,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92}
,{0x92,0xff,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0x92,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0x92}
,{0x92,0xff,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0x92,0xdb,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0xff,0x00,0xff,0x00,0xff,0x00,0xdb,0x92}
,{0x92,0xff,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0x92,0xdb,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0xdb,0x92}
,{0x92,0xff,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0x92,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0x92}
,{0x92,0xff,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0x92,0xdb,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xdb,0x92}
,{0x92,0xff,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0x92,0xdb,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xdb,0x92}
,{0x92,0xff,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0x92,0xdb,0xff,0xff,0xff,0xff,0xe0,0x80,0xff,0xff,0xff,0x03,0xff,0xff,0xff,0xff,0xff,0x10,0x1c,0xff,0xff,0xff,0xdb,0x92}
,{0x92,0xff,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0x92,0xdb,0xff,0xff,0x80,0xe0,0xfc,0x80,0xff,0xff,0xff,0x1f,0x03,0x03,0xff,0xff,0x10,0x10,0x10,0x1c,0xff,0xff,0xdb,0x92}
,{0x92,0xff,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0x92,0xdb,0xff,0xff,0xdb,0x80,0x80,0xff,0xff,0xff,0x82,0xdb,0x82,0x82,0xff,0xff,0xff,0x1c,0x03,0x03,0xff,0xff,0xdb,0x92}
,{0x92,0xff,0xfc,0xdb,0xfc,0xdb,0xfc,0xdb,0x92,0xdb,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xdb,0x92}
,{0x92,0xff,0xdb,0xfc,0xdb,0xfc,0xdb,0xfc,0x92,0xdb,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xdb,0x92}
,{0x92,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x92,0xdb,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xdb,0x92}
,{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x92,0xdb,0xff,0xff,0xff,0x1c,0x03,0xff,0xff,0xff,0xff,0xff,0x03,0xff,0xff,0xff,0x80,0xe0,0xff,0xff,0xff,0xff,0xdb,0x92}
,{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x92,0xdb,0xff,0xff,0x1c,0x10,0x03,0x03,0xff,0xff,0x03,0x03,0x1f,0xff,0xff,0xff,0x80,0xfc,0xe3,0xe3,0xff,0xff,0xdb,0x92}
,{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x92,0xdb,0xff,0xff,0x03,0x03,0x1c,0xff,0xff,0xff,0x82,0x82,0xdb,0x82,0xff,0xff,0xff,0xe3,0x80,0xdb,0xff,0xff,0xdb,0x92}
,{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x92,0xdb,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xdb,0x92}
,{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x92,0xdb,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xdb,0x92}
,{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x92,0xdb,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xdb,0x92}
,{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x92,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0x92}
,{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92}
,{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
};

uint8_t vesa_icon_color_map[255];


#define VESA_BG_COLOR VESA8_COLOR_DARK_TURQUOISE

/* http://www.piclist.com/tecHREF/datafile/charset/extractor/charset_extractor.html */

unsigned short b8to16(unsigned char c)
{
    return (((unsigned short)c)<<8 ) | c;
}

void vesa_put_pixel(uint8_t* buffer, int x,int y, unsigned char color)
{
    putpixel(buffer, x , y, color, vbe_info->pitch);
}

void vesa_put_char(uint8_t* buffer, unsigned char c, int x, int y, int color) 
{
    for (int l = 0; l < 8; l++) {
        for (int i = 8; i >= 0; i--) {
            if (font8x8_basic[c][l] & (1 << i)) {
                putpixel(buffer, (x)+i,  (y)+l, color, vbe_info->pitch);
            }
        }
    }
}

/*
    Possible icons colors prefix:
    18, 
*/
void vesa_put_icon32(uint8_t* buffer, int x, int y)
{
    for (int l = 0; l < 32; l++) {

        for (int i = 0; i < 32; i++) {
            if (test_icon32[l][i] != 0x0) {
                putpixel(buffer, (x)+i,  (y)+l, vesa_icon_color_map[test_icon32[l][i]], vbe_info->pitch);
            } else {
                //putpixel((x)+i,  (y)+l, VESA_BG_COLOR);
            }
        }
    }
}

void vesa_put_icon16(uint8_t* buffer, int x, int y)
{
    for (int l = 0; l < 16; l++) {

        for (int i = 0; i < 16; i++) {
            if (cursor[l][i] != 0x0) {
                putpixel(buffer, (x)+i,  (y)+l, vesa_icon_color_map[cursor[l][i]], vbe_info->pitch);
            } else {
                //putpixel((x)+i,  (y)+l, VESA_BG_COLOR);
            }
        }
    }
}

void vesa_write(uint8_t* buffer, int x, int y, const char* data, int size, int color)
{
	for (int i = 0; i < size; i++)
		vesa_put_char(buffer, data[i], x+(i*PIXELS_PER_CHAR), y, color);
}

void vesa_write_str(uint8_t* buffer, int x, int y, const char* data, int color)
{
	vesa_write(buffer, x, y, data, strlen(data), color);
}

void vesa_inner_box(uint8_t* buffer, int x, int y, int w, int h)
{
    vesa_fillrect(buffer, x, y, w, h, VESA8_COLOR_LIGHT_GRAY3);

    vesa_line_horizontal(buffer, x, y, w, VESA8_COLOR_DARK_GRAY2);
    vesa_line_horizontal(buffer, x, y+h, w, VESA8_COLOR_LIGHT_GRAY1);

    vesa_line_vertical(buffer, x, y, h, VESA8_COLOR_DARK_GRAY2);
    vesa_line_vertical(buffer, x+w, y, h, VESA8_COLOR_LIGHT_GRAY1);
}

void vesa_fill(uint8_t* buffer, unsigned char color)
{
    for (int i = 0; i < vbe_info->height; i++)
        for (int j = 0; j < vbe_info->width; j++)
            putpixel(buffer, j, i, color, vbe_info->pitch);
}

void vesa_fillrect(uint8_t* buffer, int x, int y, int w, int h, int color){
    int i, j;
    for (j = y; j < (y+h); j++)
        for (i = x; i < (x+w); i++)
            putpixel(buffer, i, j, color, vbe_info->pitch);
}

#define GFX_MAX_FMT_STR_SIZE 50

int vesa_printf(uint8_t* buffer, int32_t x, int32_t y, int color, char* fmt, ...)
{
	va_list args;

	int x_offset = 0;
	int written = 0;
	char str[GFX_MAX_FMT_STR_SIZE];
	int num = 0;

	va_start(args, fmt);

	while (*fmt != '\0') {
		switch (*fmt)
		{
			case '%':
				memset(str, 0, GFX_MAX_FMT_STR_SIZE);
				switch (*(fmt+1))
				{
					case 'd':
					case 'i': ;
						num = va_arg(args, int);
						itoa(num, str);
						vesa_write_str(buffer, x+(x_offset*PIXELS_PER_CHAR), y, str, color);
						x_offset += strlen(str);
						break;
                    case 'p': ; /* p for padded int */
						num = va_arg(args, int);
						itoa(num, str);
						vesa_write_str(buffer, x+(x_offset*PIXELS_PER_CHAR), y, str, color);
						x_offset += strlen(str);

                        if(strlen(str) < 3){
                            int pad = 3-strlen(str);
                            for (int i = 0; i < pad; i++){
                                vesa_put_char(buffer, ' ', x+(x_offset*PIXELS_PER_CHAR), y, color);
                                x_offset++;
                            }
                        }
						break;
					case 'x':
					case 'X': ;
						num = va_arg(args, int);
						itohex(num, str);
						vesa_write_str(buffer, x+x_offset, y, str, color);
						x_offset += strlen(str);
						break;
					case 's': ;
						char* str_arg = va_arg(args, char *);
						vesa_write_str(buffer, x+(x_offset*PIXELS_PER_CHAR), y, str_arg, color);
						x_offset += strlen(str_arg);
						break;
					case 'c': ;
						char char_arg = (char)va_arg(args, int);
						vesa_put_char(buffer, char_arg, x+(x_offset*PIXELS_PER_CHAR), y, color);
						x_offset++;
						break;
					default:
                        break;
				}
				fmt++;
				break;
			case '\n':
				y++;
				written += x_offset;
				x_offset = 0;
				break;
			default:  
				vesa_put_char(buffer, *fmt, x+(x_offset*PIXELS_PER_CHAR), y, color);
				x_offset++;
                written++;
			}
        fmt++;
    }
	written += x_offset;
	return written;
}

void vesa_init()
{
    vesa_icon_color_map[0xFF] = VESA8_COLOR_LIGHT_GRAY2;
    vesa_icon_color_map[0x92] = VESA8_COLOR_DARK_GRAY1;
    vesa_icon_color_map[0xdb] = VESA8_COLOR_GRAY1;
    vesa_icon_color_map[0xFC] = 43; // 67
    vesa_icon_color_map[0x02] = 1;
}